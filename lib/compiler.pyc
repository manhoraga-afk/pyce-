// Pycee++ Self-Hosting Compiler
// Written in Pycee++

action tokenize (source):
    group set tokens #
    number set pos to 0
    number set line to 1
    
    action skip_whitespace ():
        while pos < length(source) and (char_at(source, pos) is space or char_at(source, pos) is newline):
            if char_at(source, pos) is newline then
                line = line + 1
            end
            pos = pos + 1
        end
    end
    
    action read_identifier ():
        number set start to pos
        while pos < length(source) and (is_alpha(char_at(source, pos)) or is_digit(char_at(source, pos)) or char_at(source, pos) is _):
            pos = pos + 1
        end
        report substring(source, start, pos)
    end
    
    action read_number ():
        number set start to pos
        while pos < length(source) and (is_digit(char_at(source, pos)) or char_at(source, pos) is .):
            pos = pos + 1
        end
        report substring(source, start, pos)
    end
    
    action read_string ():
        // Skip opening quote
        pos = pos + 1
        number set start to pos
        
        while pos < length(source) and char_at(source, pos) is not ":
            if char_at(source, pos) is \ then
                pos = pos + 1 // skip escape
            end
            pos = pos + 1
        end
        
        text set content to substring(source, start, pos)
        pos = pos + 1 // skip closing quote
        report content
    end
    
    loop():
        skip_whitespace()
        if pos >= length(source) then
            exit
        end
        
        text set current to char_at(source, pos)
        
        if current is # then
            // Comment - skip to end of line
            while pos < length(source) and char_at(source, pos) is not newline:
                pos = pos + 1
            end
        else if current is " then
            token = read_string()
            add (make_token(STRING, token, line), tokens)
        else if is_alpha(current) or current is _ then
            text set ident to read_identifier()
            type = keyword_type(ident)
            add (make_token(type, ident, line), tokens)
        else if is_digit(current) then
            text set num to read_number()
            add (make_token(NUMBER, num, line), tokens)
        else if current is ( then
            add (make_token(LPAREN, "(", line), tokens)
            pos = pos + 1
        else if current is ) then
            add (make_token(RPAREN, ")", line), tokens)
            pos = pos + 1
        else if current is , then
            add (make_token(COMMA, ",", line), tokens)
            pos = pos + 1
        else if current is + then
            add (make_token(PLUS, "+", line), tokens)
            pos = pos + 1
        else if current is * then
            add (make_token(TIMES, "*", line), tokens)
            pos = pos + 1
        else if current is > then
            add (make_token(GT, ">", line), tokens)
            pos = pos + 1
        else if current is < then
            add (make_token(LT, "<", line), tokens)
            pos = pos + 1
        else if current is = then
            add (make_token(EQ, "=", line), tokens)
            pos = pos + 1
        else
            report join(Error at line, line, : unexpected character, current)
            exit
        end
    end
    
    report tokens
end

action parse (tokens):
    // Simplified recursive descent parser
    ast = parse_program(tokens)
    report ast
end

action compile_to_c (ast, output_file):
    file = open_file(output_file, write)
    write_file(file, "// Generated by Pycee++ self-hosting compiler\n")
    write_file(file, "#include \"pycee_rt.h\"\n\n")
    write_file(file, "int main() {\n")
    
    compile_node(ast, file, 1)  // indent level 1
    
    write_file(file, "    return 0;\n")
    write_file(file, "}\n")
    close_file(file)
end

action main ():
    if count(args) < 2 then
        report #Usage: pycee <input.pyc> <output.c>
        exit
    end
    
    source = read_file(args[1])
    tokens = tokenize(source)
    ast = parse(tokens)
    compile_to_c(ast, args[2])
    
    report join(âœ… Compiled, args[1], to, args[2])
end

do main()