#!/usr/bin/env python3
"""
Pycee++ Package Manager
Installs libraries from other languages into Pycee++ projects
"""

import sys
import os
import json
import shutil
import subprocess
import requests
from pathlib import Path
from urllib.parse import urlparse

REGISTRY_URL = "https://registry.pycee.org/packages"
CACHE_DIR = Path.home() / ".pycee" / "cache"
PACKAGES_DIR = Path.home() / ".pycee" / "packages"

def download_package(lang, name, version="latest"):
    """Download and install a package from the registry"""
    # Create directories
    CACHE_DIR.mkdir(parents=True, exist_ok=True)
    PACKAGES_DIR.mkdir(parents=True, exist_ok=True)

    # Get package metadata
    print(f"üîç Looking up {lang}/{name}...")
    resp = requests.get(f"{REGISTRY_URL}/{lang}/{name}.json")
    if resp.status_code != 200:
        print(f"‚ùå Package not found: {lang}/{name}")
        sys.exit(1)

    metadata = resp.json()
    version = version if version != "latest" else metadata['latest']

    if version not in metadata['versions']:
        print(f"‚ùå Version not available: {version}")
        print(f"‚úÖ Available versions: {', '.join(metadata['versions'].keys())}")
        sys.exit(1)

    pkg_info = metadata['versions'][version]
    download_url = pkg_info['url']

    # Download package
    print(f"üì• Downloading {lang}/{name}@{version}...")
    pkg_resp = requests.get(download_url, stream=True)
    if pkg_resp.status_code != 200:
        print(f"‚ùå Download failed: {download_url}")
        sys.exit(1)

    # Save to cache
    filename = os.path.basename(urlparse(download_url).path)
    cache_path = CACHE_DIR / filename

    with open(cache_path, 'wb') as f:
        for chunk in pkg_resp.iter_content(chunk_size=8192):
            f.write(chunk)

    # Extract to packages directory
    pkg_dir = PACKAGES_DIR / lang / name / version
    pkg_dir.mkdir(parents=True, exist_ok=True)

    print(f"üì¶ Extracting to {pkg_dir}...")
    if filename.endswith('.zip'):
        import zipfile
        with zipfile.ZipFile(cache_path, 'r') as zip_ref:
            zip_ref.extractall(pkg_dir)
    elif filename.endswith(('.tar.gz', '.tgz')):
        import tarfile
        with tarfile.open(cache_path, 'r:gz') as tar_ref:
            tar_ref.extractall(pkg_dir)

    # Build if needed
    if lang == "rust":
        print("‚öôÔ∏è Building Rust package...")
        subprocess.run(["cargo", "build", "--release"],
                      cwd=pkg_dir, check=True)
    elif lang == "python":
        print("üêç Setting up Python virtual environment...")
        venv_dir = pkg_dir / "venv"
        subprocess.run([sys.executable, "-m", "venv", str(venv_dir)], check=True)

        # Install requirements
        if (pkg_dir / "requirements.txt").exists():
            pip_cmd = str(venv_dir / ("bin/pip" if os.name != "nt" else "Scripts\\pip.exe"))
            subprocess.run([pip_cmd, "install", "-r", "requirements.txt"],
                          cwd=pkg_dir, check=True)

    print(f"‚úÖ Successfully installed {lang}/{name}@{version}")
    print(f"üìÅ Location: {pkg_dir}")
    return pkg_dir

def init_project():
    """Initialize a new Pycee++ project"""
    if os.path.exists("pycee.toml"):
        print("‚ö†Ô∏è Project already initialized!")
        return

    with open("pycee.toml", "w") as f:
        f.write("""# Pycee++ Project Configuration
name = "my_project"
version = "0.1.0"
description = "My Pycee++ project"

[dependencies]
# Add packages here:
# python/requests = "latest"
# rust/serde = "1.0"
""")

    # Create basic project structure
    os.makedirs("src", exist_ok=True)
    os.makedirs("lib", exist_ok=True)
    os.makedirs("samples", exist_ok=True)

    with open("src/main.pyc", "w") as f:
        f.write("""// My Pycee++ Project
set name to World
report join(Hello, name, !)
""")

    print("‚úÖ Project initialized!")
    print("üìÅ Created pycee.toml and basic project structure")
    print("‚úèÔ∏è Edit pycee.toml to add dependencies")

def main():
    if len(sys.argv) < 2:
        print("Usage:")
        print("  pycee_pkg init                   # Initialize new project")
        print("  pycee_pkg add <lang>/<package>   # Add a package")
        print("  pycee_pkg list                   # List installed packages")
        sys.exit(1)

    command = sys.argv[1]

    if command == "init":
        init_project()

    elif command == "add":
        if len(sys.argv) < 3:
            print("Usage: pycee_pkg add <lang>/<package>")
            sys.exit(1)

        package_spec = sys.argv[2]
        if '/' not in package_spec:
            print("‚ùå Invalid package format. Use: <lang>/<package>")
            print("‚úÖ Examples:")
            print("   python/requests")
            print("   rust/serde")
            print("   javascript/three")
            sys.exit(1)

        lang, name = package_spec.split('/', 1)
        download_package(lang, name)

    elif command == "list":
        if not PACKAGES_DIR.exists():
            print("üì≠ No packages installed")
            return

        print("üì¶ Installed Packages:")
        for lang_dir in PACKAGES_DIR.iterdir():
            if lang_dir.is_dir():
                for pkg_dir in lang_dir.iterdir():
                    if pkg_dir.is_dir():
                        versions = [v.name for v in pkg_dir.iterdir() if v.is_dir()]
                        print(f"  {lang_dir.name}/{pkg_dir.name}: {', '.join(versions)}")

    else:
        print(f"‚ùå Unknown command: {command}")
        sys.exit(1)

if __name__ == "__main__":
    main()